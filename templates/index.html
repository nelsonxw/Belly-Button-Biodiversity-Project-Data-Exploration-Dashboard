<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>Belly Button Biodiversity Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="jumbotron text-center">
          <h1>Belly Button Biodiversity Dashboard</h1> 
          <p>Use the interactive charts below to explore the dataset</p> 
        </div>

		<div class="row">
		    <div class="col-md-2">
		    	<div class="selection text-center" style="background-color: #E7ECF0; height: 100px;width: 220px; padding-top: 20px;">
				    <div style="font-weight: bold;"> Select Sample:</div>
				    <div>
				        <select style="margin-top: 10px;" id="selSample" onchange="getData(this.value)">
				        </select>
				    </div>
				</div>

			    <div class="row">
			    	<table style="margin-top:20px;margin-left: 15px; border-width: 1px;border-style: solid;border-color: #73a2ef">
			    		<thead>
			    			<tr>
			    				<th style="padding-bottom: 20px;padding-left: 30px;padding-right: 55px;background-color: #73a2ef">Sample MetaData</th>
			    			</tr>
			    		</thead>
			    		<tbody id="metadata" style="padding-left: 30px;"></tbody>
			    	</table>
			    </div>    	
		    </div>
			
			<div class="col-md-5">
			    <dir class="charting-area-pie">
			    	<div id="pieChart"></div>
			    </dir>    	
		    </div>

			<div class="col-md-5">
				<dir class="charting-area-gauge">
			    	<div id="gaugeChart"></div>
			    </dir>    	
		    </div>
		</div>

		<div class="charting-area-bubble">
	    	<div id="bubbleChart"></div>
	    </div>
    </div>
    <script>
        /*populute selection options*/
        var name_url = "/names";
        Plotly.d3.json(name_url, function(error, data) {
            if (error) return console.warn(error);
            names = Object.values(data);
            for (var n = 0; n < names.length; n++) {
                var $option = document.createElement("option");
                var $selection = document.querySelector("#selSample")
                $option.value = names[n];
                $option.innerHTML = names[n];
                $selection.appendChild($option);
            };
        })

		/*Plot pie chart*/
		default_selection = "BB_940";
        Plotly.d3.json(`/samples/${default_selection}`, function(error, data) {
            if (error) return console.warn(error);
            var sample_value = data[0].sampleValue;
            var otuID = data[0].otu_id
            var otuDescription = data[0].otu_descriptions
            var sample_top10 = sample_value.slice(0,10);
            var otuID_top10 = otuID.slice(0,10);
            var otuDescription_top10 = otuDescription.slice(0,10);
            var piedata = [{
                labels: otuID_top10,
                values: sample_top10,
                type: "pie",
                hovertext:otuDescription_top10
            }];
            var layout = {
              height: 400,
              width: 500
            };
			Plotly.newPlot("pieChart",piedata,layout);

			var bubbledata = [{
			  x: otuID,
			  y: sample_value,
			  text: otuDescription,
			  mode: 'markers',
			  marker: {
			    size: sample_value,
			    color: otuID,
			    colorscale:"Earth",
			  }
			}];
			Plotly.newPlot("bubbleChart",bubbledata);

        });  

        /*show metadata*/
        show_metadata(default_selection);

        function show_metadata (route) {
        	Plotly.d3.json(`/metadata/${route}`, function(error, data) {
	            if (error) return console.warn(error);
		        var $tbody = document.querySelector("#metadata");
		        $tbody.innerHTML="";
		        for (k in data[0]) {
					var $tr = document.createElement("tr");
					var $td = document.createElement("td");
					$td.innerText = k + ": " + data[0][k];
		        	$tr.appendChild($td);
		        	$tbody.appendChild($tr);
		        };
		        var $tds = document.querySelectorAll("td");
		        for (var i=0;i<$tds.length;i++) {
		        	$tds[i].style.paddingLeft="30px";
		        	$tds[i].style.paddingBottom="5px";
		        }
	        });
        }
        

        /*update the plot with new data*/
        function updateCharts(newdata) {
            
            var newsample_value = newdata[0].sampleValue;
            var newotuID = newdata[0].otu_id;
            var newotuDescription = newdata[0].otu_descriptions;
            var newsample_top10 = newsample_value.slice(0,10);
            var newotuID_top10 = newotuID.slice(0,10);
            var newotuDescription_top10 = newotuDescription.slice(0,10);
            
            var update_pie = {
            	labels: [newotuID_top10],
                values: [newsample_top10],
                hovertext:[newotuDescription_top10]
            }
            Plotly.restyle("pieChart", update_pie);

            var update_bubble = {
			  x: [newotuID],
			  y: [newsample_value],
			  text: [newotuDescription],
			};
			Plotly.restyle("bubbleChart",update_bubble);


        }
        // Get new data whenever the dropdown selection changes
        function getData(route) {
            
            Plotly.d3.json(`/samples/${route}`, function(error, data) {
            updateCharts(data);
            	
            });
            show_metadata(route);
        }

        
            
        

        


    </script>

    
</body>
</html>